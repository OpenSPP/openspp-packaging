# OpenSPP Build Process Documentation

## Overview

OpenSPP uses a **vendoring-based build system** that ensures reproducible builds across all environments. The build process follows a manifest → lockfile → vendor → tarball workflow.

## Architecture

```
dependencies.yaml    (manifest - what we want)
        ↓
dependencies.lock.yaml (lockfile - exact versions)
        ↓
vendor/              (local cache of all dependencies)
        ↓
openspp-X.Y.Z-source.tar.gz (distributable artifact)
```

## Key Components

### 1. Dependencies Manifest (`dependencies.yaml`)
- **Purpose**: Single source of truth for all dependencies
- **Contents**: 
  - Odoo core repository and branch
  - OpenSPP/OpenG2P addon repositories
  - OCA community modules (selective inclusion)
- **Format**: Human-readable YAML with repository URLs and refs

### 2. Lockfile (`dependencies.lock.yaml`)
- **Purpose**: Ensures reproducible builds
- **Contents**: Resolved commit SHAs for all git references
- **Generated by**: `python vendorize.py --lock`
- **Updated**: When dependencies change

### 3. Vendorize Script (`vendorize.py`)
- **Purpose**: Manages the entire vendoring process
- **Features**:
  - Resolves git refs to commit SHAs
  - Clones repositories with caching support
  - Selective module copying
  - Source tarball generation

### 4. Python Dependencies
- **Abstract deps**: `requirements.in` (for pip-compile)
- **Pinned deps**: `requirements.txt` (exact versions)
- **Dev deps**: `requirements-dev.txt` (testing/linting tools)

## Common Workflows

### Adding a New Dependency

1. **Edit the manifest**:
   ```bash
   vim dependencies.yaml
   ```
   Add your repository:
   ```yaml
   addons:
     new_addon:
       url: "https://github.com/org/repo.git"
       ref: "17.0"
       modules:  # Optional: specify modules
         - "module1"
         - "module2"
   ```

2. **Update the lockfile**:
   ```bash
   python vendorize.py --lock
   ```
   This will:
   - Resolve the ref to a commit SHA
   - Update `dependencies.lock.yaml`
   - Vendor the new dependency

3. **Test locally**:
   ```bash
   ./test-local.sh
   ```

4. **Commit both files**:
   ```bash
   git add dependencies.yaml dependencies.lock.yaml
   git commit -m "feat: add new_addon dependency"
   ```

### Updating Dependencies

1. **Update versions in manifest**:
   ```bash
   vim dependencies.yaml
   # Change ref from "17.0" to "17.0.1" for example
   ```

2. **Regenerate lockfile**:
   ```bash
   python vendorize.py --lock
   ```

3. **Test the updates**:
   ```bash
   ./test-quick.sh
   ```

4. **Commit changes**:
   ```bash
   git add dependencies.yaml dependencies.lock.yaml
   git commit -m "chore: update dependencies"
   ```

### Building from Scratch

```bash
# Clean everything
python vendorize.py --clean
python vendorize.py --clean-cache  # Only if you want fresh clones

# Vendor all dependencies
python vendorize.py --lock

# Create source tarball
python vendorize.py --tarball 17.0.2

# The tarball contains everything needed for builds
ls -lh openspp-17.0.2-source.tar.gz
```

### Using Build Cache

The vendorize script now supports caching to speed up builds:

```bash
# First run - clones everything
python vendorize.py --lock
# Takes ~5-10 minutes

# Subsequent runs - uses cache
python vendorize.py --sync
# Takes ~30 seconds

# Force fresh clones
python vendorize.py --clean-cache
python vendorize.py --lock
```

## Python Dependencies Management

### Using pip-tools for Pinning

1. **Edit abstract dependencies**:
   ```bash
   vim requirements.in
   ```

2. **Compile to pinned versions**:
   ```bash
   pip-compile requirements.in
   ```

3. **Update all dependencies**:
   ```bash
   pip-compile --upgrade requirements.in
   ```

4. **Install for development**:
   ```bash
   pip install -r requirements.txt
   pip install -r requirements-dev.txt
   ```

## CI/CD Integration

### GitHub Actions Workflow

The CI pipeline automatically:
1. Creates lockfile from dependencies.yaml
2. Vendors all dependencies
3. Creates source tarball
4. Builds all package formats (wheel, deb, rpm, docker)
5. Runs security scans
6. Publishes artifacts

### Security Scanning

Multiple security tools run on every commit:
- **Safety**: Checks Python dependencies for known vulnerabilities
- **pip-audit**: Audits Python packages
- **Trivy**: Scans for vulnerabilities in all files
- **Dependabot**: Automated dependency updates

## Build Performance Tips

### 1. Use Caching
- The `.tmp_vendor_clones/` directory caches git repositories
- Subsequent builds are 10-20x faster
- Clean cache only when necessary

### 2. Parallel Operations
- The vendorize script clones repositories in sequence
- CI/CD builds packages in parallel
- Local builds can use `make -j4` for parallelism

### 3. Selective Module Inclusion
- Only include needed modules from large repositories
- Reduces tarball size significantly
- Example: OCA repos often have 50+ modules, we may only need 1-2

## Troubleshooting

### Problem: Vendorize fails with network error
**Solution**: The script has retry logic, but you can increase retries:
```python
# In vendorize.py, change:
run_cmd(cmd, retries=5, delay=10)
```

### Problem: Lockfile conflicts in merge
**Solution**: Always regenerate lockfile after merge:
```bash
git checkout main
git pull
python vendorize.py --lock
git add dependencies.lock.yaml
git commit -m "chore: regenerate lockfile after merge"
```

### Problem: Build cache is corrupted
**Solution**: Clean and rebuild:
```bash
python vendorize.py --clean-cache
python vendorize.py --clean
python vendorize.py --lock
```

### Problem: Dependency version conflict
**Solution**: Use pip-compile to resolve:
```bash
pip-compile requirements.in 2>&1 | grep -i conflict
# Adjust version constraints in requirements.in
pip-compile requirements.in
```

## Best Practices

1. **Always commit both files**: When changing dependencies, commit both `dependencies.yaml` and `dependencies.lock.yaml`

2. **Test before committing**: Run at least `./test-quick.sh` before pushing dependency changes

3. **Use semantic commit messages**:
   - `feat: add new module X`
   - `fix: update module Y to fix security issue`
   - `chore: update dependencies`

4. **Document why**: Add comments in `dependencies.yaml` explaining why specific modules or versions are needed

5. **Regular updates**: Run security scans weekly and update vulnerable dependencies promptly

6. **Monitor tarball size**: Keep the source tarball under 500MB if possible

## Performance Metrics

Typical build times:
- **First vendor (no cache)**: 5-10 minutes
- **Cached vendor**: 20-30 seconds
- **Source tarball creation**: 10-15 seconds
- **Python wheel build**: 30-45 seconds
- **Full CI pipeline**: 15-20 minutes

## Questions?

For questions about the build process:
1. Check this documentation
2. Review the vendorize.py source code
3. Ask in the OpenSPP development chat
4. Create an issue on GitHub